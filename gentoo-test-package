#!/usr/bin/env python


def massage_string(string):
    """Return a string."""

    import sys

    if sys.version_info[0] < 3:
        return string
    else:
        return string.decode("UTF-8")


class Docker:

    def __init__(self, local_portage, update=True, threads=1):
        """Create a new container.

        local_portage is the path to the local portage repository. The
        update argument specifies whether to update the container. The threads
        variable specifies how many threads emerge should use.
        """

        import subprocess

        docker_args = [
            "docker", "run", "--detach", "--tty",
            "--volume=%s:/usr/portage" % (local_portage),
            "--volume=/usr/portage/distfiles:/usr/portage/distfiles",
            "gentoo/stage3-amd64-nomultilib"]
        print("creating docker container with: %s" % (" ".join(docker_args)))
        docker = subprocess.Popen(docker_args, stdout=subprocess.PIPE)
        docker.wait()
        if docker.returncode != 0:
            raise Exception("failure creating docker container")
        lines = docker.stdout.readlines()
        if len(lines) > 1:
            raise Exception("more output than expected")
        self.cid = massage_string(lines[0]).strip()
        # Update bash environment.
        self.exec("echo HISTORY=1000 >> /root/.bashrc")
        # Disable the usersandbox feature, it's not working well inside a
        # docker container.
        self.exec("echo FEATURES=\\\"-sandbox -usersandbox\\\" " +
                  ">> /etc/portage/make.conf")
        self.exec(("echo MAKEOPTS=\\\"-j%d\\\" " % (threads)) +
                  ">> /etc/portage/make.conf")
        self.exec("emerge --info")
        # Update.
        if update:
            self.exec("emerge --update --deep --newuse @world")

    def exec(self, cmd, interactive=False):
        """Execute command in container.

        cmd is a string which is executed within a bash shell.
        """

        import subprocess

        print("running \"%s\" in container" % (cmd))
        docker_cmd = ["docker", "exec"]
        if interactive:
            docker_cmd += ["--tty", "--interactive"]
        docker_cmd += [self.cid, "/bin/bash", "-c", cmd]
        docker = subprocess.Popen(docker_cmd)
        docker.wait()
        if docker.returncode != 0:
            print("running in container %s" % (str(self.cid)))
            raise Exception("failed command \"%s\"" % (cmd))

    def shell(self):
        """Run an interactive shell in container."""

        import subprocess

        print("running interactive shell in container")
        docker = subprocess.Popen(["docker", "exec", "--tty", "--interactive",
                                  self.cid, "/bin/bash"])
        docker.wait()


def main():
    """The main function."""

    import argparse
    import os.path

    parser = argparse.ArgumentParser()
    parser.add_argument(
        "ATOM",
        help="The package atom to test")
    parser.add_argument(
        "--portage-dir",
        help="The local portage directory",
        required=True)
    parser.add_argument(
        "--no-update",
        help="Do not update container before installing ATOM",
        default=False,
        action="store_true")
    parser.add_argument(
        "--threads",
        metavar="N",
        help="Use N threads to build packages",
        default=1,
        type=int)
    parser.add_argument(
        "--use",
        help="The use flags for the ATOM",
        nargs="+")
    options = parser.parse_args()
    print("creating container")
    container = Docker(os.path.abspath(options.portage_dir),
                       update=(not options.no_update),
                       threads=options.threads)
    print("created container " + container.cid)
    container.exec(
        "echo \"%s\" ~amd64 >> /etc/portage/package.accept_keywords" %
        (options.ATOM))
    container.exec("cat /etc/portage/package.accept_keywords")
    if not (options.use is None) and len(options.use) > 0:
        container.exec("echo %s %s >> /etc/portage/package.use/testbuild" %
                       (options.ATOM, " ".join(options.use)))
    container.exec("emerge --ask --verbose %s" % (options.ATOM))
    container.shell()


if __name__ == "__main__":
    main()
else:
    raise Exception("can not be imported")
